<!DOCTYPE html>
<html lang="et">
<head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-T81QWPXXR1"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-T81QWPXXR1');
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>T√§na me ei skoori!</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        :root {
            --bg-color: #fffdf9;
            --color-par-minus-1: #3ec30057;
            --color-par-minus-2: #3ec300a3;
            --color-par-plus-1: #f42b031f;
            --color-par-plus-2: #f42b0342;
            --color-par-plus-3: #f42b036b;
            --color-ace: #ffb400;
            --header-bg: #444;
            --header-text: #fff;
            --sub-header-bg: #777;
            --rating-bg: #BBB;
            --rating-text: #444;
        }

        body {
            background-color: var(--bg-color);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }

        /* Tabeli stiilid */
        .table-container {
            overflow-x: auto;
            position: relative;
            max-height: 80vh; /* Hoiab tabeli ekraani piires */
        }

        table {
            font-size: 14px;
            line-height: 16px;
            border-collapse: separate; /* Vajalik sticky headeri jaoks borderitega */
            border-spacing: 0;
            width: 100%;
        }

        table td, table th {
            border: 1px solid #d8dfdb;
            text-align: center;
            padding: 6px 4px;
            vertical-align: middle;
        }

        /* Sticky Header Logic */
        thead th {
            position: sticky;
            z-index: 10;
        }

        /* M√§√§rame sticky positsioonid igale p√§isereale */
        tr#table-header th { top: 0; background-color: var(--header-bg); color: var(--header-text); border-color: #555; height: 40px; }
        tr#tulemus th { top: 40px; background-color: var(--sub-header-bg); color: white; font-size: 0.85em; height: 30px; }
        tr#rating th { top: 70px; background-color: var(--rating-bg); color: var(--rating-text); font-size: 0.85em; height: 30px; }
        tr#labitud th { top: 100px; background-color: white; color: #777; font-size: 0.85em; height: 30px; border-bottom: 2px solid #ccc; }

        /* Tulemuste v√§rvid */
        td.par-1 { background-color: var(--color-par-minus-1); }
        td.par-2 { background-color: var(--color-par-minus-2); }
        td.par1 { background-color: var(--color-par-plus-1); }
        td.par2 { background-color: var(--color-par-plus-2); }
        td.par3, td.par4, td.par5, td.par6 { background-color: var(--color-par-plus-3); }
        td.holari { background-color: var(--color-ace) !important; font-weight: bold; }
        td.penalty { border: 2px solid red !important; }

        .korviNumber { font-weight: 700; font-size: 1.1em; }
        .numberAlt { color: #777; font-size: 0.8em; display: block; }
        
        .playerNimi { font-weight: 600; text-transform: uppercase; }

        /* Legend */
        #lyhendid { font-size: 0.85em; color: #555; line-height: 1.4; }

        /* Checkbox list stiilid */
        .player-checkbox-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            padding: 0.5rem;
            background: #fff;
        }
        .form-check {
            margin-bottom: 0.25rem;
        }
        
        /* Custom Orange Button */
        .btn-orange {
            background-color: #ff6700;
            border-color: #ff6700;
            color: white;
        }
        .btn-orange:hover, .btn-orange:active, .btn-orange:focus {
            background-color: #dd5a00;
            border-color: #dd5a00;
            color: white;
        }
    </style>
</head>
<body>

<div class="container-fluid py-3 px-2">
    <!-- Seaded Accordion -->
    <div class="accordion mb-3" id="settingsAccordion">
        <div class="accordion-item">
            <h2 class="accordion-header" id="headingOne">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSettings" aria-expanded="false" aria-controls="collapseSettings">
                    ‚öôÔ∏è Seaded ja M√§ngijad
                </button>
            </h2>
            <div id="collapseSettings" class="accordion-collapse collapse" aria-labelledby="headingOne" data-bs-parent="#settingsAccordion">
                <div class="accordion-body bg-light">
                    <div class="mb-3">
                        <label for="gameID" class="form-label fw-bold">M√§ngu URL v√µi ID:</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="gameID" placeholder="Kopeeri siia m√§ngu link: https://discgolfmetrix.com/...">
                            <button class="btn btn-primary" type="button" onclick="loadPlayers()">Lae m√§ngijad</button>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold">Vali m√§ngijad:</label>
                        <div class="d-flex gap-2 mb-2">
                            <button class="btn btn-sm btn-outline-secondary" onclick="toggleAllPlayers(true)">Vali k√µik</button>
                            <button class="btn btn-sm btn-outline-secondary" onclick="toggleAllPlayers(false)">T√ºhista valik</button>
                        </div>
                        <div id="playerCheckboxes" class="player-checkbox-list">
                            <div class="text-muted small p-2">M√§ngijate laadimiseks sisesta ID ja vajuta nuppu...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Juhtnupud -->
    <button type="button" class="btn btn-orange w-100 py-2 mb-3 fw-bold shadow-sm" onclick="fetchResults()">
        üîÑ Lae / V√§rskenda tulemusi
    </button>

    <!-- Legend -->
    <div id="lyhendid" class="mb-2 px-1"></div>

    <!-- Tulemuste tabel -->
    <div class="table-container shadow-sm rounded">
        <table class="table mb-0">
            <thead>
                <tr id="table-header">
                    <!-- M√§ngijate initsiaalid -->
                    <th>#</th>
                </tr>
                <tr id="tulemus">
                    <!-- +/- skoor -->
                    <th>+/-</th>
                </tr>
                <tr id="rating">
                    <!-- Reiting -->
                    <th>Rtg</th>
                </tr>
                <tr id="labitud">
                    <!-- L√§bitud korvid -->
                    <th>L√§b</th>
                </tr>
            </thead>
            <tbody id="table-body">
                <!-- Sisu genereeritakse JS-iga -->
            </tbody>
        </table>
    </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    let competitionID = "";
    let courseID = "";
    // M√§rkus: API kood peaks ideaalis olema server-side v√µi peidetud, 
    // kuid front-end lahenduse puhul on see paratamatu.
    const pCode = "PtEwQhiM7PMOc6NMEv0tk9pBW4Rthaum";
    let ratingKordaja = 0;   
    let ratingVabaliige = 0; 
    let par0Value = 0;

    // Helper: Parsib URL-ist v√µi stringist ID
    function getCompetitionIdFromInput() {
        const inputVal = document.getElementById("gameID").value.trim();
        if (inputVal.includes("discgolfmetrix.com")) {
            competitionID = inputVal.split("/").pop();
            return competitionID; 
        }
        return inputVal;
    }

    async function loadPlayers() {
        competitionID = getCompetitionIdFromInput();
        if (!competitionID) {
            alert("Palun sisesta korrektne ID v√µi URL");
            return;
        }

        try {
            const response = await fetch(`https://discgolfmetrix.com/api.php?content=result&id=${competitionID}`);
            const json = await response.json();
            
            if (!json.Competition) {
                alert("Viga andmete laadimisel. Kontrolli ID-d.");
                return;
            }

            courseID = json.Competition.CourseID;

            const container = document.getElementById("playerCheckboxes");
            container.innerHTML = "";

            // Sorteeri nime j√§rgi
            const sortedResults = json.Competition.Results.sort((a, b) => a.Name.localeCompare(b.Name));

            if (sortedResults.length === 0) {
                container.innerHTML = "<div class='p-2'>M√§ngijaid ei leitud.</div>";
                return;
            }

            sortedResults.forEach(player => {
                const div = document.createElement("div");
                div.className = "form-check";
                
                const checkbox = document.createElement("input");
                checkbox.className = "form-check-input player-checkbox";
                checkbox.type = "checkbox";
                checkbox.value = player.UserID;
                checkbox.id = `player-${player.UserID}`;
                // Vaikimisi valime k√µik, v√µi laseme kasutajal valida
                // checkbox.checked = true; 

                const label = document.createElement("label");
                label.className = "form-check-label";
                label.htmlFor = `player-${player.UserID}`;
                label.textContent = player.Name;

                div.appendChild(checkbox);
                div.appendChild(label);
                container.appendChild(div);
            });

            // Ava seaded, kui need pole lahti (et kasutaja n√§eks m√§ngijaid)
            const collapseElement = document.getElementById('collapseSettings');
            const bsCollapse = new bootstrap.Collapse(collapseElement, { toggle: false });
            bsCollapse.show();

            loadCourseInfo();

        } catch (error) {
            console.error(error);
            alert("Viga √ºhenduses Discgolfmetrixiga.");
        }
    }

    function toggleAllPlayers(check) {
        const checkboxes = document.querySelectorAll('.player-checkbox');
        checkboxes.forEach(cb => cb.checked = check);
    }

    async function loadCourseInfo() {
        try {
            const response = await fetch(`https://discgolfmetrix.com/api.php?content=course&id=${courseID}&code=${pCode}`);
            const json = await response.json();

            const course = json.course;
            const baskets = json.baskets;
            const ratingValue1 = parseFloat(course.RatingValue1);
            const ratingValue2 = parseFloat(course.RatingValue2);
            const ratingResult1 = parseFloat(course.RatingResult1);
            const ratingResult2 = parseFloat(course.RatingResult2);

            // Reitingu arvutus
            ratingKordaja = (ratingValue2 - ratingValue1) / (ratingResult2 - ratingResult1);
            ratingVabaliige = ratingValue1 - ratingKordaja * ratingResult1;

            par0Value = baskets.reduce((sum, b) => sum + Number(b.Par || 0), 0);
        } catch (e) {
            console.log("Course info loading failed (might be expected for non-admin API)", e);
        }
    }

    function getRating(diff) {
        if (!ratingKordaja) return 0; // Kui reitingu infot ei saadud
        return ratingKordaja * (diff + par0Value) + ratingVabaliige;
    }

    async function fetchResults() {
        competitionID = getCompetitionIdFromInput();
        if (!competitionID) return;

        // Leia valitud m√§ngijad checkboxidest
        const checkboxes = document.querySelectorAll('.player-checkbox:checked');
        const selectedIds = Array.from(checkboxes).map(cb => cb.value);

        if (selectedIds.length === 0) {
            alert("Palun vali v√§hemalt √ºks m√§ngija seadete alt.");
            return;
        }

        try {
            const response = await fetch(`https://discgolfmetrix.com/api.php?content=result&id=${competitionID}`);
            const json = await response.json();
            
            const results = json.Competition.Results.filter(p => selectedIds.includes(p.UserID));
            const korvid = json.Competition.Tracks;

            // Uuenda legendi
            const divLyhendid = document.getElementById("lyhendid");
            divLyhendid.innerHTML = "";

            // Uuenda p√§iseid
            const tableHeader = document.getElementById("table-header");
            const tableHeaderTulemus = document.getElementById("tulemus");
            const tableHeaderLabitud = document.getElementById("labitud");
            const tableHeaderRating = document.getElementById("rating");

            // Reset headers (s√§ilita esimene t√ºhi lahter)
            tableHeader.innerHTML = "<th>#</th>";
            tableHeaderTulemus.innerHTML = "<th>+/-</th>";
            tableHeaderLabitud.innerHTML = "<th>L√§b</th>";
            tableHeaderRating.innerHTML = "<th>Rtg</th>";

            results.forEach(player => {
                const initials = player.Name.split(" ").map(n => n.charAt(0)).join("");
                
                // Lisa legendi
                const badge = document.createElement("span");
                badge.className = "badge bg-secondary me-1 mb-1 fw-normal";
                badge.textContent = `${initials}: ${player.Name}`;
                divLyhendid.appendChild(badge);

                // P√§is: Initsiaalid
                const th = document.createElement("th");
                th.className = "playerNimi";
                th.textContent = initials;
                tableHeader.appendChild(th);

                // P√§is: Tulemus
                const thTul = document.createElement("th");
                // Kui Diff on null v√µi t√ºhi string, kuva midagi muud v√µi 0
                const displayDiff = (player.Diff === null || player.Diff === "") ? "-" : player.Diff;
                const place = player.Place ? `(${player.Place})` : "";
                thTul.textContent = `${displayDiff} ${place}`;
                tableHeaderTulemus.appendChild(thTul);

                // P√§is: Rating
                const thRating = document.createElement("th");
                let ratingVal = "-";
                if (player.Diff !== null && player.Diff !== "" && ratingKordaja) {
                    ratingVal = Math.round(getRating(parseInt(player.Diff)));
                }
                thRating.textContent = ratingVal;
                tableHeaderRating.appendChild(thRating);
            });

            // Tabeli sisu
            const tableBody = document.getElementById("table-body");
            tableBody.innerHTML = "";

            if (!results.length || !results[0].PlayerResults) return;

            const playedHolesCount = new Array(results.length).fill(0);

            // Itereeri l√§bi radade (korvide)
            for (let i = 0; i < results[0].PlayerResults.length; i++) {
                const row = document.createElement("tr");

                // Korvi numbri lahter
                const tdKorv = document.createElement("td");
                const divK = document.createElement("div");
                divK.className = "korviNumber";
                
                const korv = korvid[i];
                divK.textContent = korv.Number;
                tdKorv.appendChild(divK);

                if (korv.NumberAlt) {
                    const divAlt = document.createElement("span");
                    divAlt.className = "numberAlt";
                    divAlt.textContent = `(${korv.NumberAlt})`;
                    tdKorv.appendChild(divAlt);
                }
                row.appendChild(tdKorv);

                // Iga m√§ngija tulemus sellel rajal
                results.forEach((player, playerIndex) => {
                    const td = document.createElement("td");
                    const pr = player.PlayerResults[i];

                    if (pr && pr.Result !== undefined && pr.Result !== "" && pr.Result !== null) {
                        playedHolesCount[playerIndex]++;
                        
                        const { Result: res, Diff: diff, PEN: penalty } = pr;

                        // V√§rvi loogika
                        if (res == 1) {
                            td.classList.add("holari");
                        } else {
                            // diff on string API-s m√µnikord, castime
                            td.classList.add(`par${diff}`);
                        }

                        if (penalty == 1) {
                            td.classList.add("penalty");
                        }
                        td.textContent = res;
                    } else {
                        // M√§ngimata rada
                        td.textContent = "";
                    }
                    row.appendChild(td);
                });

                tableBody.appendChild(row);
            }

            // L√§bitud korvide rida p√§isesse (d√ºnaamiliselt t√§idetud loopis, n√º√ºd lisame DOM-i)
            results.forEach((player, idx) => {
                const thLab = document.createElement("th");
                thLab.textContent = `${playedHolesCount[idx]}/${results[idx].PlayerResults.length}`;
                tableHeaderLabitud.appendChild(thLab);
            });

            // Sulge seaded automaatselt, et n√§ha tulemusi
            const collapseElement = document.getElementById('collapseSettings');
            const bsCollapse = bootstrap.Collapse.getInstance(collapseElement);
            if(bsCollapse) bsCollapse.hide();

        } catch (error) {
            console.error(error);
            alert("Viga tulemuste laadimisel.");
        }
    }
</script>

</body>
</html>
