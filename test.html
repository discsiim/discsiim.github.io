<!DOCTYPE html>
<html lang="et">
<head>
	<!-- Google tag (gtag.js) -->
	<script async src="https://www.googletagmanager.com/gtag/js?id=G-T81QWPXXR1"></script>
	<script>
  		window.dataLayer = window.dataLayer || [];
  		function gtag(){dataLayer.push(arguments);}
  		gtag('js', new Date());

  		gtag('config', 'G-T81QWPXXR1');
	</script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
	<!-- ‚úÖ Bootstrap CSS -->
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <title>T√§na me ei skoori!</title>
  <style>
    body {
      background-color: #fffdf9;
      font-family: "Segoe UI", sans-serif;
    }

    h2 {
      font-size: 1rem;
      font-weight: 700;
    }

    /* M√§ngijate tabeli v√§rvid ja efektid */
    table {
      font-size: 14px;
      line-height: 16px;
      border-collapse: collapse;
    }

    table th, table td {
      text-align: center;
      padding: 4px 3px;
      border: 1px solid #dee2e6;
    }

    thead {
      position: sticky;
      top: 0;
      z-index: 10;
    }

    tr#table-header {
      background-color: #212529;
      color: #fff;
    }

    tr#tulemus {
      background-color: #6c757d;
      color: white;
    }

    tr#rating {
      background-color: #adb5bd;
      color: #333;
    }

    tr#labitud {
      background-color: #f8f9fa;
      color: #777;
    }

    td.par-1 { background-color: #3ec30057; }
    td.par-2 { background-color: #3ec300a3; }
    td.par1 { background-color: #f42b031f; }
    td.par2 { background-color: #f42b0342; }
    td.par3, td.par4, td.par5, td.par6 { background-color: #f42b036b; }

    td.holari { background-color: #ffb400; }
    td.penalty { border: 2px solid red; }

    /* Stiilne oran≈æ nupp */
    .refresh {
      background-color: #ff6700;
      color: white;
      border: none;
      border-radius: 10px;
      padding: 10px;
      width: 100%;
      margin-top: 10px;
      font-size: 16px;
      font-weight: 500;
      transition: background-color 0.2s, transform 0.1s;
    }

    .refresh:hover {
      background-color: #dd5a00;
      transform: scale(1.02);
    }

    /* Bootstrap accordion-like collapsible */
    .collapsible {
      background-color: #6c757d;
      color: white;
      border: none;
      border-radius: 10px;
      padding: 8px;
      width: 100%;
      text-align: center;
      font-size: 16px;
      cursor: pointer;
    }

    .collapsible:hover {
      background-color: #495057;
    }
	
	.collapsible:after {
		  content: '\002B';
		  color: white;
		  font-weight: bold;
		  float: right;
		  margin-left: 5px;
	}
	.active:after {
		  content: "\2212";
	}

    .settings {
      padding: 12px;
      border-radius: 0 0 10px 10px;
      background-color: #f8f9fa;
      border: 1px solid #dee2e6;
      margin-bottom: 12px;
    }

    div#lyhendid {
      font-size: 0.85em;
      margin-bottom: 10px;
      color: #666;
    }

    .playerNimi {
      font-weight: 600;
    }
  </style>
</head>
<body class="container py-3">

  <button type="button" class="collapsible mb-2">‚öôÔ∏è Seaded</button>
  <div class="settings">
    <h2>M√§ngu URL:</h2>
    <div class="input-group mb-2">
      <input type="text" id="gameID" class="form-control" placeholder="https://discgolfmetrix.com/...">
      <button class="btn btn-secondary" onclick="loadPlayers()">Lae m√§ngijad</button>
    </div>

    <h2>Vali m√§ngijad:</h2>
    <select id="playerSelect" multiple class="form-select"></select>
  </div>

  <button type="button" class="refresh" onclick="fetchResults()">üîÑ Lae / v√§rskenda tulemusi</button>

  <div id="lyhendid" class="mt-2"></div>

  <div class="table-responsive mt-3">
    <table class="table table-bordered table-sm align-middle text-center">
      <thead>
        <tr id="table-header"><th></th></tr>
        <tr id="tulemus"><th>+/-</th></tr>
        <tr id="rating"><th>Rtg</th></tr>
        <tr id="labitud"><th>L√§b</th></tr>
      </thead>
      <tbody id="table-body"></tbody>
    </table>
  </div>

  <!-- Bootstrap JS (vajalik m√µne komponendi jaoks) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
	
    <script>
		let competitionID = "3213882";
        let courseID="";
        const pCode="PtEwQhiM7PMOc6NMEv0tk9pBW4Rthaum";
        let ratingKordaja = 0;   
        let ratingVabaliige = 0; 
        let par0Value = 0;

        async function fetchResults() {
            const response = await fetch(`https://discgolfmetrix.com/api.php?content=result&id=${competitionID}`);
            const json = await response.json();

            const selectedPlayers = Array.from(document.getElementById("playerSelect").selectedOptions)
                .map(opt => opt.value);
            const results = json.Competition.Results.filter(p => selectedPlayers.includes(p.UserID));
            const korvid = json.Competition.Tracks;

            const divLyhendid = document.getElementById("lyhendid");
            divLyhendid.innerHTML = "";

            const tableHeader = document.getElementById("table-header");
            const tableHeaderTulemus = document.getElementById("tulemus");
            const tableHeaderLabitud = document.getElementById("labitud");
            const tableHeaderRating = document.getElementById("rating");

            tableHeader.innerHTML = "<th></th>";
            tableHeaderTulemus.innerHTML = "<th>+/-</th>";
            tableHeaderLabitud.innerHTML = "<th>L√§b</th>";
            tableHeaderRating.innerHTML = "<th>Rtg</th>";

            for (const player of results) {
                const th = document.createElement("th");
                th.classList.add("playerNimi");

                // Kuvatakse ainult initsiaalid:
                const initials = player.Name.split(" ").map(n => n.charAt(0)).join("");
                divLyhendid.textContent += `${initials}: ${player.Name}, `;
                th.textContent = initials;
                tableHeader.appendChild(th);

                const thTul = document.createElement("th");
                thTul.textContent = `${player.Diff} (${player.Place})`;
                tableHeaderTulemus.appendChild(thTul);

                const thRating=document.createElement("th");
                let ratingVal=getRating(parseInt(player.Diff));
                thRating.textContent=`${Math.round(ratingVal)}`;
                tableHeaderRating.appendChild(thRating);
            }

            const tableBody = document.getElementById("table-body");
            tableBody.innerHTML = "";

            const playedHolesCount = new Array(results.length).fill(0);

            for (let i = 0; i < results[0].PlayerResults.length; i++) {
                const row = document.createElement("tr");

                const tdKorv = document.createElement("td");
                const divK = document.createElement("div");
                divK.classList.add("korviNumber");

                const korv = korvid[i];
                divK.textContent = korv.Number;
                tdKorv.appendChild(divK);

                if (korv.NumberAlt) {
                    const divAlt = document.createElement("div");
                    divAlt.classList.add("numberAlt");
                    divAlt.textContent = `(${korv.NumberAlt})`;
                    tdKorv.appendChild(divAlt);
                }

                row.appendChild(tdKorv);

                for (let col = 0; col < results.length; col++) {
                    const td = document.createElement("td");
                    const pr = results[col].PlayerResults[i];

                    if (pr && pr.Result !== undefined && pr.Result !== "") {
                        playedHolesCount[col]++;
                    }

                    if (pr) {
                        const { Result: res, Diff: diff, PEN: penalty } = pr;

                        if (res == 1) {
                            td.classList.add("holari");
                        } else {
                            td.classList.add(`par${diff}`);
                        }

                        if (penalty == 1) {
                            td.classList.add("penalty");
                        }

                        td.textContent = res;
                    }

                    row.appendChild(td);
                }

                tableBody.appendChild(row);
            }

            // l√§bitud/l√§bimata korvid
            for (let i = 0; i < results.length; i++) {
                const thLab = document.createElement("th");
                thLab.textContent = `${playedHolesCount[i]}/${results[i].PlayerResults.length}`;
                tableHeaderLabitud.appendChild(thLab);
            }
        }

        async function loadPlayers() {
            const compUrl = document.getElementById("gameID").value;
            competitionID = compUrl.split("/").pop();
            
            const response = await fetch(`https://discgolfmetrix.com/api.php?content=result&id=${competitionID}`);
            const json = await response.json();
            courseID=json.Competition.CourseID;



            const select = document.getElementById("playerSelect");
            select.innerHTML = "";

            // Sorteeri m√§ngijad nime j√§rgi
            json.Competition.Results.sort((a, b) => a.Name.localeCompare(b.Name));

            for (const player of json.Competition.Results) {
                const option = document.createElement("option");
                option.value = player.UserID;
                option.textContent = player.Name;
                select.appendChild(option);
            }
            loadCourseInfo();
        }
        async function loadCourseInfo(){
            const response = await fetch(`https://discgolfmetrix.com/api.php?content=course&id=${courseID}&code=PtEwQhiM7PMOc6NMEv0tk9pBW4Rthaum`);
            const json = await response.json();

            const course = json.course;
            const baskets = json.baskets;
            const ratingValue1 = parseFloat(course.RatingValue1);
            const ratingValue2 = parseFloat(course.RatingValue2);
            const ratingResult1 = parseFloat(course.RatingResult1);
            const ratingResult2 = parseFloat(course.RatingResult2);

            //jooksva ringireitingu arvutamiseks vajalikud muutujad
            ratingKordaja = (ratingValue2 - ratingValue1) / (ratingResult2 - ratingResult1);
            ratingVabaliige = ratingValue1 - ratingKordaja * ratingResult1;

            // Sum all Par values
            par0Value = baskets.reduce((sum, b) => sum + Number(b.Par || 0), 0);  
        }
		function getRating(diff) {
            return ratingKordaja * (diff+ par0Value) + ratingVabaliige;
        }

		/*Settingud collapsible'iks*/
		const coll = document.getElementsByClassName("collapsible");
		let i;

		for (i = 0; i < coll.length; i++) {
		  coll[i].addEventListener("click", function() {
			this.classList.toggle("active");
			let content = this.nextElementSibling;
			if (content.style.maxHeight){
			  content.style.maxHeight = null;
			} else {
			  content.style.maxHeight = content.scrollHeight + "px";
			} 
		  });
		}
        //document.addEventListener("DOMContentLoaded", loadPlayers);
    </script>
</body>
</html>
